---
title: Mysql的MVCC机制
abbrlink: 368c6375
date: 2023-10-07 18:13:47
categories:
 - 中间件
tags:
 - Mysql
---

# Mysql的MVCC机制

### 引言

在之前的文章中，我们提到了Mysql的事务和ACID性质，那么数据库是如何保证隔事务的离性呢？数据库是通过**加锁**，来实现事务的隔离性的。这就好像，如果你想一个人静静，不被别人打扰，你就可以在房门上加上一把锁。

加锁确实好使，可以保证隔离性。比如**串行化隔离级别就是加锁实现的**。但是频繁的加锁，导致读数据时，没办法修改，修改数据时，没办法读取，大大**降低了数据库性能**。

**那么，如何解决加锁后的性能问题的？**

答案就是,**MVCC多版本并发控制**！它实现读取数据不用加锁，可以让读取数据同时修改。修改数据时同时可读取。

### 1.什么是MVCC

MVCC，即**Multi-Version Concurrency Control （多版本并发控制）**。它是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存。

> 通俗的讲，数据库中同时存在多个版本的数据，并不是整个数据库的多个版本，而是某一条记录的多个版本同时存在，在某个事务对其进行操作的时候，需要查看这一条记录的隐藏列事务版本id，比对事务id并根据事物隔离级别去判断读取哪个版本的数据。

数据库隔离级别读**已提交、可重复读** 都是基于MVCC实现的，相对于加锁简单粗暴的方式，它用更好的方式去处理读写冲突，能有效提高数据库并发性能。

### 2.MVCC实现的关键知识

#### 2.1 事务版本号

> 事务每次开启前，都会从数据库获得一个自增长的事务ID，可以从事务ID去判断事务的执行顺序，这就是事务版本号。

#### 2.2 隐式字段

对于InnoDB存储引擎，每一行记录都有两个隐藏列**trx_id**、**roll_pointer**，如果表中没有主键和非NULL唯一键时，则还会有第三个隐藏的主键列**row_id**。

| 列名         | 是否必须 | 描述                                             |
| ------------ | -------- | ------------------------------------------------ |
| row_id       | 否       | 单调递增的行ID，不是必需的，占用6个字节。        |
| trx_id       | 是       | 记录操作该数据事务的事务ID                       |
| roll_pointer | 是       | 这个隐藏列就相当于一个指针，指向回滚段的undo日志 |

#### 2.3 undo log

undo log，**回滚日志**，用于记录数据被修改前的信息。在表记录修改之前，会先把数据拷贝到undo log里，如果事务回滚，即可以通过undo log来还原数据。

可以这样认为，当delete一条记录时，undo log中记录一条对应的insert记录，当update一条记录时，它记录一条对应的相反的update记录。

哪undo log有什么用途呢？

1. 事务回滚时，保证原子性和一致性
2. 用于MVCC快照读

#### 2.4 版本连

多个事务并行操作某一行数据时，不同事务对该行数据的修改会产生多个版本，然后通过回滚指针（roll_pointer），连成一个链表，这个链表就称为**版本链**。如下：



